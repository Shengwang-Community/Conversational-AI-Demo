# ConvoAI Android - Cursor AI å¼€å‘è§„èŒƒ

> **é‡è¦**: åœ¨å¼€å§‹ä»»ä½•ç¼–ç ä»»åŠ¡å‰ï¼Œè¯·å…ˆé˜…è¯»æœ¬æ–‡æ¡£äº†è§£å®Œæ•´å¼€å‘è§„èŒƒã€‚

## é¡¹ç›®æ¦‚è¿°

Android ç«¯å¯¹è¯å¼ AI Agent åº”ç”¨ï¼ŒåŸºäº Kotlin + AndroidX + MVVM æ¶æ„ã€‚

## æ ¸å¿ƒè§„åˆ™

### æŠ€æœ¯æ ˆ
- **è¯­è¨€**: Kotlinï¼ˆJVM Target 17ï¼‰
- **æœ€ä½ SDK**: API Level 24 (Android 7.0)
- **ç›®æ ‡ SDK**: API Level 35
- **æ¶æ„**: MVVM (ViewModel + LiveData/StateFlow)
- **UI ç»‘å®š**: ViewBindingï¼ˆå¿…é¡»ä½¿ç”¨ï¼Œç¦æ­¢ findViewByIdï¼‰
- **å¼‚æ­¥å¤„ç†**: Kotlin Coroutines + Flow
- **ç½‘ç»œè¯·æ±‚**: OkHttp + Retrofit + Gson
- **å›¾ç‰‡åŠ è½½**: Glide
- **æœ¬åœ°å­˜å‚¨**: MMKV
- **å¯¼èˆª**: Navigation Component

### å…³é”®çº¦æŸ
1. **ä¸ä¿®æ”¹** `convoaiApi/` ç›®å½•ä¸‹çš„æ ¸å¿ƒ API å®ç°
2. **æäº¤å‰å¿…é¡»è¿è¡Œ** `./gradlew lint` å¹¶ç¡®ä¿é€šè¿‡
3. **èµ„æºå‰ç¼€**: `scenes/convoai` æ¨¡å—ä½¿ç”¨ `cov_` å‰ç¼€
4. **ViewBinding**: æ‰€æœ‰ Activity/Fragment å¿…é¡»ä½¿ç”¨ ViewBindingï¼Œç¦æ­¢ findViewById

### æ–‡ä»¶å‘½å
- **Kotlin æ–‡ä»¶**: `PascalCase`ï¼ˆå¦‚ `CovListViewModel.kt`ï¼‰
- **ç±»å**: `PascalCase`ï¼ˆå¦‚ `CovListViewModel`ï¼‰
- **å¸ƒå±€æ–‡ä»¶**: `snake_case`ï¼ˆå¦‚ `cov_activity_main.xml`ï¼‰
- **èµ„æºæ–‡ä»¶**: `snake_case`ï¼ˆå¦‚ `cov_ic_agent_add.xml`ï¼‰
- **å¸¸é‡**: `UPPER_SNAKE_CASE`ï¼ˆå¦‚ `TAB_AGENT_LIST`ï¼‰

### æ¶æ„æ¨¡å¼

#### MVVM ä¸‰å±‚æ¶æ„
```
UI Layer (Activity/Fragment)
    â†“
ViewModel (çŠ¶æ€ç®¡ç† + ä¸šåŠ¡é€»è¾‘)
    â†“
Repository/API Manager (æ•°æ®å±‚)
```

#### ViewModel è§„èŒƒ
- ç»§æ‰¿ `ViewModel`
- ä½¿ç”¨ `viewModelScope` å¤„ç†åç¨‹
- çŠ¶æ€ä½¿ç”¨ `LiveData` æˆ– `StateFlow`
- ç§æœ‰æ•°æ®ä½¿ç”¨ `MutableLiveData`/`MutableStateFlow`ï¼Œå…¬å¼€åªè¯»ç‰ˆæœ¬

```kotlin
class CovListViewModel : ViewModel() {
    private val _officialAgents = MutableLiveData<List<CovAgentPreset>>()
    val officialAgents: LiveData<List<CovAgentPreset>> = _officialAgents
    
    fun loadOfficialAgents() {
        viewModelScope.launch {
            // ä¸šåŠ¡é€»è¾‘
        }
    }
}
```

#### çŠ¶æ€ç®¡ç†å†³ç­–
- **UI çŠ¶æ€** â†’ `LiveData`ï¼ˆActivity/Fragment è§‚å¯Ÿï¼‰
- **å¤æ‚çŠ¶æ€æµ** â†’ `StateFlow`ï¼ˆéœ€è¦èƒŒå‹å¤„ç†ï¼‰
- **è·¨ Activity å…±äº«** â†’ `GlobalViewModel`ï¼ˆå¦‚ `GlobalUserViewModel`ï¼‰
- **ç»„ä»¶å†…éƒ¨çŠ¶æ€** â†’ `StateFlow` æˆ–å±€éƒ¨å˜é‡

### ç»„ä»¶è§„èŒƒ

#### Activity
- ç»§æ‰¿ `DebugSupportActivity<Binding>`ï¼ˆæ”¯æŒè°ƒè¯•æ¨¡å¼ï¼‰
- ä½¿ç”¨ ViewBindingï¼š`getViewBinding(): Binding`
- ViewModel ä½¿ç”¨ `by viewModels()` æˆ– `by lazy { GlobalViewModel.getInstance() }`
- ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿä½¿ç”¨ `lifecycleScope`

```kotlin
class CovMainActivity : DebugSupportActivity<CovActivityMainBinding>() {
    private val viewModel: CovListViewModel by viewModels()
    
    override fun getViewBinding(): CovActivityMainBinding = 
        CovActivityMainBinding.inflate(layoutInflater)
    
    override fun initView() {
        // UI åˆå§‹åŒ–
    }
}
```

#### Fragment
- ä½¿ç”¨ ViewBinding
- ViewModel ä½¿ç”¨ `by viewModels()` æˆ– `by activityViewModels()`
- è§‚å¯Ÿ LiveData ä½¿ç”¨ `viewLifecycleOwner`

```kotlin
class CovAgentListFragment : Fragment() {
    private val viewModel: CovListViewModel by activityViewModels()
    
    override fun onCreateView(...): View {
        val binding = CovFragmentAgentListBinding.inflate(...)
        return binding.root
    }
    
    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        viewModel.officialAgents.observe(viewLifecycleOwner) { agents ->
            // æ›´æ–° UI
        }
    }
}
```

#### çŠ¶æ€å°è£…
ä½¿ç”¨ `sealed class` å°è£…å¤æ‚çŠ¶æ€ï¼š

```kotlin
sealed class AgentListState {
    object Loading : AgentListState()
    object Success : AgentListState()
    data class Error(val message: String) : AgentListState()
    object Empty : AgentListState()
}
```

### API å¼€å‘è§„èŒƒ

#### API Manager æ¨¡å¼
- ä½¿ç”¨ `object` å•ä¾‹ï¼ˆå¦‚ `CovAgentApiManager`ï¼‰
- å›è°ƒä½¿ç”¨ `(error: ApiException?, data: T) -> Unit`
- é”™è¯¯ç å®šä¹‰ä¸ºå¸¸é‡ï¼ˆå¦‚ `ERROR_AGENT_OFFLINE = 1800`ï¼‰
- ä½¿ç”¨ `CovLogger` è®°å½•æ—¥å¿—

```kotlin
object CovAgentApiManager {
    const val ERROR_AGENT_OFFLINE = 1800
    
    fun fetchPresets(isDebug: Boolean, completion: (error: ApiException?, presets: List<CovAgentPreset>) -> Unit) {
        // API è°ƒç”¨
    }
}
```

#### ç½‘ç»œè¯·æ±‚
- ä½¿ç”¨ `SecureOkHttpClient.create().build()`
- è¯·æ±‚ä½“ä½¿ç”¨ `JSONObject` æˆ– `GsonTools`
- å“åº”è§£æä½¿ç”¨ `JSONObject` æˆ– Gson
- é”™è¯¯å¤„ç†ç»Ÿä¸€ä½¿ç”¨ `ApiException`

### èµ„æºç®¡ç†

#### å­—ç¬¦ä¸²èµ„æº
- æ‰€æœ‰ç”¨æˆ·å¯è§æ–‡æœ¬å¿…é¡»å®šä¹‰åœ¨ `strings.xml`
- ä½¿ç”¨èµ„æº IDï¼š`R.string.cov_xxx`
- å¤šè¯­è¨€æ”¯æŒé€šè¿‡ `LocaleManager` ç®¡ç†

#### å›¾ç‰‡èµ„æº
- ä½¿ç”¨ Glide åŠ è½½å›¾ç‰‡
- å ä½ç¬¦å’Œé”™è¯¯å›¾ä½¿ç”¨èµ„æº ID
- å›¾ç‰‡å‘½åï¼š`cov_ic_{åŠŸèƒ½}_{æè¿°}`

#### é¢œè‰²èµ„æº
- å®šä¹‰åœ¨ `colors.xml`
- æ”¯æŒæ·±è‰²æ¨¡å¼ï¼ˆ`values-night/colors.xml`ï¼‰

### æ—¥å¿—è§„èŒƒ

#### ä½¿ç”¨ CovLogger
```kotlin
import io.agora.scene.convoai.CovLogger

private val TAG = "ClassName"

CovLogger.d(TAG, "Debug message")
CovLogger.e(TAG, "Error message: ${error.message}")
CovLogger.json(TAG, jsonString) // JSON æ—¥å¿—
```

### é”™è¯¯å¤„ç†

#### Toast æç¤º
ä½¿ç”¨ `ToastUtil.show(R.string.cov_error_message)` æˆ– `ToastUtil.show("message")`

#### é”™è¯¯çŠ¶æ€
- ViewModel ä¸­ä½¿ç”¨ `sealed class` å°è£…é”™è¯¯çŠ¶æ€
- UI å±‚æ ¹æ®é”™è¯¯çŠ¶æ€æ˜¾ç¤ºç›¸åº”æç¤º

### æœ¬åœ°å­˜å‚¨

#### ä½¿ç”¨ LocalStorageUtil
```kotlin
import io.agora.scene.common.util.LocalStorageUtil

// å­˜å‚¨
LocalStorageUtil.putString(key, value)

// è¯»å–
val value = LocalStorageUtil.getString(key, defaultValue)
```

### åç¨‹ä½¿ç”¨

#### ViewModel ä¸­
```kotlin
viewModelScope.launch {
    try {
        // å¼‚æ­¥æ“ä½œ
    } catch (e: Exception) {
        // é”™è¯¯å¤„ç†
    }
}
```

#### Activity/Fragment ä¸­
```kotlin
lifecycleScope.launch {
    // ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥çš„åç¨‹
}
```

### ç»„ä»¶æ–‡æ¡£æŸ¥æ‰¾

å½“ä½¿ç”¨æˆ–ä¿®æ”¹ç»„ä»¶/æ¨¡å—æ—¶ï¼Œå…ˆæŸ¥çœ‹ç›®å½•ä¸‹æ˜¯å¦æœ‰ README.mdï¼š

```bash
# æ ¸å¿ƒ API æ–‡æ¡£
scenes/convoai/src/main/java/io/agora/scene/convoai/convoaiApi/README.md  # ConversationalAI API

# æ¨¡å—æ–‡æ¡£
scenes/convoai/README.md  # ConvoAI æ¨¡å—æ€»è§ˆ
```

**è§„åˆ™**ï¼š
- ä½¿ç”¨ç»„ä»¶/æ¨¡å—å‰å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ README
- ä¼˜å…ˆå‚è€ƒç›®å½•ä¸‹çš„æ–‡æ¡£
- API é›†æˆå‚è€ƒ `convoaiApi/README.md`

## å¸¸ç”¨å‘½ä»¤

```bash
./gradlew assembleDebug      # æ„å»º Debug APK
./gradlew assembleRelease    # æ„å»º Release APK
./gradlew lint               # ä»£ç æ£€æŸ¥ï¼ˆå¿…é¡»é€šè¿‡ï¼‰
./gradlew test               # è¿è¡Œæµ‹è¯•
./gradlew clean              # æ¸…ç†æ„å»º
```

## ä»£ç ç¤ºä¾‹

### å®Œæ•´çš„ ViewModel ç¤ºä¾‹
```kotlin
class CovListViewModel : ViewModel() {
    private val TAG = "CovListViewModel"
    
    // æ•°æ®å­˜å‚¨
    private val _officialAgents = MutableLiveData<List<CovAgentPreset>>()
    val officialAgents: LiveData<List<CovAgentPreset>> = _officialAgents
    
    // çŠ¶æ€ç®¡ç†
    private val _officialState = MutableLiveData<AgentListState>()
    val officialState: LiveData<AgentListState> = _officialState
    
    sealed class AgentListState {
        object Loading : AgentListState()
        object Success : AgentListState()
        data class Error(val message: String) : AgentListState()
        object Empty : AgentListState()
    }
    
    fun loadOfficialAgents() {
        viewModelScope.launch {
            try {
                _officialState.value = AgentListState.Loading
                CovAgentApiManager.fetchPresets(isDebug) { error, presets ->
                    if (error != null) {
                        CovLogger.e(TAG, "Failed: ${error.message}")
                        _officialState.value = AgentListState.Error("")
                    } else {
                        _officialAgents.value = presets
                        _officialState.value = if (presets.isEmpty()) {
                            AgentListState.Empty
                        } else {
                            AgentListState.Success
                        }
                    }
                }
            } catch (e: Exception) {
                CovLogger.e(TAG, "Exception: ${e.message}")
                _officialState.value = AgentListState.Error("")
            }
        }
    }
}
```

### å®Œæ•´çš„ Fragment ç¤ºä¾‹
```kotlin
class CovAgentListFragment : Fragment() {
    private var _binding: CovFragmentAgentListBinding? = null
    private val binding get() = _binding!!
    
    private val viewModel: CovListViewModel by activityViewModels()
    
    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        _binding = CovFragmentAgentListBinding.inflate(inflater, container, false)
        return binding.root
    }
    
    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        
        // è§‚å¯Ÿæ•°æ®
        viewModel.officialAgents.observe(viewLifecycleOwner) { agents ->
            updateAgentList(agents)
        }
        
        // è§‚å¯ŸçŠ¶æ€
        viewModel.officialState.observe(viewLifecycleOwner) { state ->
            when (state) {
                is CovListViewModel.AgentListState.Loading -> showLoading()
                is CovListViewModel.AgentListState.Success -> hideLoading()
                is CovListViewModel.AgentListState.Error -> showError()
                is CovListViewModel.AgentListState.Empty -> showEmpty()
            }
        }
        
        // åŠ è½½æ•°æ®
        viewModel.loadOfficialAgents()
    }
    
    override fun onDestroyView() {
        super.onDestroyView()
        _binding = null
    }
}
```

## Git Commit æ ¼å¼

```bash
git commit -m "<type>(<scope>): <summary>

## Changes
- <detail 1>
- <detail 2>

Generated with AI Agent"
```

**Type**: `feat`, `fix`, `docs`, `refactor`, `perf`, `test`, `chore`, `style`

**è§„åˆ™**:
- âœ… æœ«å°¾æ·»åŠ  `Generated with AI Agent`
- âŒ ä¸è¦æ·»åŠ é“¾æ¥å’Œå›¾æ ‡ï¼ˆå¦‚ ğŸ¤–ï¼‰
- âŒ ä¸è¦æ·»åŠ  `Co-Authored-By` å­—æ®µ
- âœ… åŸå­æ€§æäº¤ï¼ˆæ¯ä¸ª commit åªåšä¸€ä»¶äº‹ï¼‰

---

## æ³¨æ„äº‹é¡¹

1. **å†…å­˜æ³„æ¼é¢„é˜²**
   - Fragment ä¸­ ViewBinding åœ¨ `onDestroyView()` ä¸­ç½®ä¸º null
   - LiveData è§‚å¯Ÿä½¿ç”¨ `viewLifecycleOwner`ï¼ˆFragmentï¼‰æˆ– `this`ï¼ˆActivityï¼‰
   - åç¨‹ä½¿ç”¨ `viewModelScope` æˆ– `lifecycleScope`

2. **çº¿ç¨‹å®‰å…¨**
   - LiveData æ›´æ–°åœ¨ä¸»çº¿ç¨‹
   - ç½‘ç»œè¯·æ±‚åœ¨åå°çº¿ç¨‹ï¼Œå›è°ƒåˆ‡æ¢åˆ°ä¸»çº¿ç¨‹
   - ä½¿ç”¨ `runOnMainThread { }` ç¡®ä¿ä¸»çº¿ç¨‹æ‰§è¡Œ

3. **èµ„æºç®¡ç†**
   - å›¾ç‰‡ä½¿ç”¨ Glide è‡ªåŠ¨ç®¡ç†å†…å­˜
   - ç½‘ç»œè¯·æ±‚ä½¿ç”¨ OkHttp è¿æ¥æ± 
   - æœ¬åœ°å­˜å‚¨ä½¿ç”¨ MMKVï¼ˆé«˜æ€§èƒ½ï¼‰

4. **è°ƒè¯•æ”¯æŒ**
   - Activity ç»§æ‰¿ `DebugSupportActivity` æ”¯æŒè°ƒè¯•æ¨¡å¼
   - ä½¿ç”¨ `DebugConfigSettings.isDebug` åˆ¤æ–­è°ƒè¯•æ¨¡å¼
   - æ—¥å¿—ä½¿ç”¨ `CovLogger` ç»Ÿä¸€ç®¡ç†
